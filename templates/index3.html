<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¦ æ™ºèƒ½ä»“å‚¨è‡ªåŠ¨åˆ†æç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#6366F1',
            accent: '#8B5CF6',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            info: '#06B6D4',
            light: '#F3F4F6',
            dark: '#1F2937'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .bg-gradient-soft {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e5e6 100%);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
      }
      .status-badge {
        @apply px-3 py-1 rounded-full text-sm font-medium inline-flex items-center;
      }
      .status-badge-green {
        @apply bg-success/10 text-success border border-success/30;
      }
      .status-badge-yellow {
        @apply bg-warning/10 text-warning border border-warning/30;
      }
      .status-badge-red {
        @apply bg-danger/10 text-danger border border-danger/30;
      }
      .file-item {
        @apply flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors;
      }
      .file-item.active {
        @apply bg-blue-50 border-l-4 border-primary;
      }
      .btn-refresh {
        @apply bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition duration-300;
      }
      .btn-primary {
        @apply bg-primary text-white font-medium py-2 px-4 rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition duration-300;
      }
      .notification {
        @apply fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50;
      }
      /* æ–°å¢ï¼šå›ºå®šæ–‡ä»¶åˆ—è¡¨é«˜åº¦å¹¶å¯ç”¨æ»šåŠ¨ */
      .fixed-file-list {
        max-height: calc(100vh + 200px); /* æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´é«˜åº¦ */
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f8fafc;
      }
      .fixed-file-list::-webkit-scrollbar {
        width: 6px;
      }
      .fixed-file-list::-webkit-scrollbar-track {
        background: #f8fafc;
      }
      .fixed-file-list::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 3px;
      }
      .fixed-file-list::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
      }

       /* æ–°å¢ï¼šæ–‡ä»¶åˆ—è¡¨é¢œè‰²é˜ˆå€¼ */
      .ratio-success {
        @apply text-success font-bold;
      }
      .ratio-warning {
        @apply text-warning font-bold;
      }
      .ratio-danger {
        @apply text-danger font-bold;
      }
    }
  </style>
</head>
<body class="font-inter bg-gradient-soft min-h-screen">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="fixed top-0 left-0 w-full bg-white/80 backdrop-blur-md shadow-sm z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-cubes text-primary text-2xl"></i>
        <span class="text-xl font-bold text-dark">æ™ºèƒ½ä»“å‚¨è‡ªåŠ¨åˆ†æç³»ç»Ÿ</span>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <span id="systemStatus" class="status-badge status-badge-yellow">
            <i class="fa fa-circle mr-1"></i>åˆå§‹åŒ–ä¸­
          </span>
          <span id="connectionStatus" class="status-badge status-badge-yellow">
            <i class="fa fa-refresh fa-spin mr-1"></i>è¿æ¥ä¸­
          </span>
          <span id="lastUpdateTime" class="text-sm text-gray-500">ä¸Šæ¬¡æ›´æ–°: å°šæœªåˆ†æ</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <main class="container mx-auto px-4 pt-24 pb-16">
    <div class="max-w-7xl mx-auto">
      <!-- æ ‡é¢˜åŒºåŸŸ -->
      <div class="text-center mb-10 animate-fade-in">
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-dark mb-4">
          <i class="fa fa-bar-chart text-primary mr-2"></i> ä»“åº“ç©ºé—´åˆ©ç”¨ç‡åˆ†æ
        </h1>
        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
          ç³»ç»Ÿå®ç°è‡ªåŠ¨æŠ“æ‹ï¼Œå®æ—¶åˆ†æåº“å­˜å®¹é‡
        </p>
      </div>

      <!-- ç›‘æ§çŠ¶æ€åŒºåŸŸ -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden card-hover mb-6 animate-slide-up">
        <!-- æ·»åŠ ç»Ÿä¸€å¤´éƒ¨ -->
        <div class="p-4 bg-blue-50 border-b border-gray-100">
          <h3 class="text-xl font-semibold text-dark flex items-center">
            <i class="fa fa-folder-open-o text-primary mr-2"></i> ç›‘æ§åº“å­˜ç…§ç‰‡çŠ¶æ€
          </h3>
        </div>
        <!-- ä¿ç•™åŸæœ‰å†…å®¹ -->
        <div class="p-6">
          <div class="space-y-4">
            <div class="p-4 bg-gray-50 rounded-xl">
              <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-2">
                <span class="text-gray-600 mb-2 md:mb-0">ç›‘æ§æŠ“æ‹å›¾åƒè·¯å¾„ :</span>
                <span class="text-primary break-all">./auto_detect/</span>
              </div>
              <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div class="w-full md:w-3/4 bg-gray-200 rounded-full h-2.5 mb-2 md:mb-0">
                  <div id="fileStatusBar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex items-center space-x-4">
                  <span class="text-sm text-gray-500" id="processedCount">å·²å¤„ç†: 0 ä¸ªæ–‡ä»¶</span>
                  <span class="text-sm text-gray-500" id="currentFile">å½“å‰: æ— </span>
                </div>
              </div>
            </div>

            <div class="flex justify-between">
              <button id="refreshAnalysis" class="btn-refresh flex items-center">
                <i class="fa fa-refresh mr-2"></i>æ‰‹åŠ¨åˆ·æ–°åˆ†æ
              </button>
              <button id="toggleAutoRefresh" class="btn-primary flex items-center" id="autoRefreshBtn">
                <i class="fa fa-sync-alt mr-2"></i>è‡ªåŠ¨åˆ·æ–°: å¯ç”¨
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden h-full flex flex-col card-hover mb-6">
            <!-- ä¿®æ”¹ä¸ºä¸å…¶ä»–åŒºå—ä¸€è‡´çš„å¤´éƒ¨ -->
            <div class="p-4 bg-blue-50 border-b border-gray-100">
              <h3 class="text-xl font-semibold text-dark flex items-center">
                <i class="fa fa-file-image-o text-primary mr-2"></i> æ–‡ä»¶åˆ—è¡¨
              </h3>
              <!-- æ·»åŠ é¢œè‰²å›¾ä¾‹ -->
              <div class="flex space-x-2">
                <div class="flex items-center text-xs">
                  <div class="w-3 h-3 rounded-full bg-success mr-1"></div>
                  <span>&lt;50%</span>
                </div>
                <div class="flex items-center text-xs">
                  <div class="w-3 h-3 rounded-full bg-warning mr-1"></div>
                  <span>50-70%</span>
                </div>
                <div class="flex items-center text-xs">
                  <div class="w-3 h-3 rounded-full bg-danger mr-1"></div>
                  <span>&gt;70%</span>
                </div>
              </div>
            </div>
            <!-- å…³é”®ä¿®æ”¹ï¼šæ·»åŠ fixed-file-listç±»å¹¶è®¾ç½®é«˜åº¦ -->
            <div id="fileList" class="fixed-file-list p-6">
              <!-- æ–‡ä»¶é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
              <div class="text-center text-gray-400">
                <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                <p>æš‚æ— åˆ†ææ–‡ä»¶</p>
              </div>
            </div>
          </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="resultBlock" class="lg:col-span-3 space-y-6 opacity-0 transition-opacity duration-500">
          <!-- ç»“æœä¿¡æ¯å¡ç‰‡ -->
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden card-hover mb-6">
            <div class="p-4 bg-blue-50 border-b border-gray-100">
              <h3 class="text-xl font-semibold text-dark flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>åˆ†æç»“æœ
                <span id="currentFileName" class="ml-2 text-sm font-normal text-gray-500">æ–‡ä»¶: æ— </span>
              </h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-4 bg-purple-50 rounded-xl">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">è´§ç‰©å åœ°æ¯”ä¾‹</span>
                    <span class="font-bold text-primary" id="cargoRatio">--</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="ratioBar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                  </div>
                </div>

                <div class="p-4 bg-green-50 rounded-xl" id="efficiencyInfo" style="display: none;">
                  <h4 class="font-semibold text-success mb-2">ç©ºé—´æ•ˆç‡è¯„ä¼°</h4>
                  <p id="efficiencyText" class="text-gray-600"></p>
                </div>

                <div class="p-4 bg-yellow-50 rounded-xl" id="timestampInfo" style="display: none;">
                  <h4 class="font-semibold text-warning mb-2">åˆ†ææ—¶é—´</h4>
                  <p id="timestampText" class="text-gray-600"></p>
                </div>
              </div>

              <div class="mt-6 p-4 bg-red-50 rounded-xl" id="recommendationBox" style="display: none;">
                <h4 class="font-semibold text-warning mb-2">ä¼˜åŒ–å»ºè®®</h4>
                <ul id="recommendations" class="text-gray-600 space-y-2 list-disc pl-5"></ul>
              </div>
            </div>
          </div>

          <!-- å›¾åƒåˆ†æç»“æœå±•ç¤ºåŒºåŸŸ -->
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden card-hover mb-6">
            <div class="p-4 bg-blue-50 border-b border-gray-100">
              <h3 class="text-xl font-semibold text-dark flex items-center">
                <i class="fa fa-image text-primary mr-2"></i> å›¾åƒåˆ†æç»“æœ
              </h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
              <div class="bg-white rounded-xl shadow-md overflow-hidden result-container">
                <div class="h-[280px] bg-gray-100 flex items-center justify-center relative">
                  <img id="original-image" src="" alt="åŸå§‹å›¾åƒ" class="max-h-full max-w-full object-contain">
                  <div id="noImagePlaceholder" class="text-center text-gray-400">
                    <i class="fa fa-image text-4xl mb-2"></i>
                    <p>ç­‰å¾…åŠ è½½åŸå§‹å›¾åƒ...</p>
                  </div>
                </div>
                <div class="p-4 text-center">
                  <h4 class="font-semibold text-dark">ğŸ“· åŸå§‹å›¾åƒ</h4>
                </div>
              </div>

              <div class="bg-white rounded-xl shadow-md overflow-hidden result-container">
                <div class="h-[280px] bg-gray-100 flex items-center justify-center relative">
                  <img id="result-image" src="" alt="åˆ†æå›¾åƒ" class="max-h-full max-w-full object-contain">
                  <div id="noResultPlaceholder" class="text-center text-gray-400">
                    <i class="fa fa-area-chart text-4xl mb-2"></i>
                    <p>ç­‰å¾…åŠ è½½åˆ†æç»“æœ...</p>
                  </div>
                </div>
                <div class="p-4 text-center">
                  <h4 class="font-semibold text-dark">ğŸ“Š åˆ†å‰²å›¾åƒ</h4>
                </div>
              </div>
            </div>
          </div>

          <!-- è¯¦ç»†æ•°æ®å›¾è¡¨ -->
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden card-hover mb-6">
            <div class="p-4 bg-blue-50 border-b border-gray-100">
              <h3 class="text-xl font-semibold text-dark flex items-center">
                <i class="fa fa-line-chart text-primary mr-2"></i>ç©ºé—´ä½¿ç”¨è¶‹åŠ¿
              </h3>
            </div>
            <div class="p-6">
              <div class="h-64">
              <canvas id="trendChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- é¡µè„š -->
  <footer class="bg-dark text-white py-6">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row justify-between items-center max-w-5xl mx-auto">
        <!-- ç³»ç»Ÿåç§°éƒ¨åˆ† -->
        <div class="mb-4 md:mb-0">
          <h3 class="text-base md:text-lg font-semibold mb-1">æ™ºèƒ½ä»“å‚¨è‡ªåŠ¨åˆ†æç³»ç»Ÿ</h3>
          <p class="text-gray-400 text-xs md:text-sm">è‡ªåŠ¨ç›‘æ§ä»“åº“å›¾åƒï¼Œå®æ—¶åˆ†æç©ºé—´åˆ©ç”¨æƒ…å†µ</p>
        </div>

        <!-- è”ç³»æˆ‘ä»¬éƒ¨åˆ† -->
        <div class="mb-4 md:mb-0 md:px-4">
          <h3 class="text-base md:text-lg font-semibold mb-1">æŠ€æœ¯æ”¯æŒ</h3>
          <ul class="text-gray-400 text-xs md:text-sm space-y-1">
            <li><i class="fa fa-envelope-o mr-1"></i> ******@***********************</li>
            <li><i class="fa fa-phone mr-1"></i> ****-*******</li>
          </ul>
        </div>

        <!-- å…³æ³¨æˆ‘ä»¬éƒ¨åˆ† -->
        <div>
          <h3 class="text-base md:text-lg font-semibold mb-1">å…³æ³¨æˆ‘ä»¬</h3>
          <div class="flex space-x-2">
            <a href="#" class="w-7 h-7 rounded-full bg-white/10 flex items-center justify-center hover:bg-primary transition-colors text-xs">
              <i class="fa fa-weixin"></i>
            </a>
            <a href="#" class="w-7 h-7 rounded-full bg-white/10 flex items-center justify-center hover:bg-primary transition-colors text-xs">
              <i class="fa fa-weibo"></i>
            </a>
            <a href="#" class="w-7 h-7 rounded-full bg-white/10 flex items-center justify-center hover:bg-primary transition-colors text-xs">
              <i class="fa fa-linkedin"></i>
            </a>
          </div>
        </div>
      </div>
      <div class="mt-6 pt-4 border-t border-gray-700 text-center text-gray-400 text-xs md:text-sm">
        &copy; 2025 æ™ºèƒ½ä»“å‚¨è‡ªåŠ¨åˆ†æç³»ç»Ÿ ç‰ˆæƒæ‰€æœ‰
      </div>
    </div>
  </footer>

  <!-- åŠ è½½ä¸­å¼¹çª— -->
  <div id="loadingModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
      <div class="text-center">
        <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-spinner fa-spin text-3xl text-primary"></i>
        </div>
        <h3 class="text-xl font-bold text-dark mb-2">åˆ†æä¸­</h3>
        <p class="text-gray-600" id="loadingMessage">ç³»ç»Ÿæ­£åœ¨å¤„ç†å›¾åƒï¼Œè¯·ç¨å€™...</p>
      </div>
    </div>
  </div>

  <!-- é¢„è­¦å¼¹çª— -->
  <div id="alarmModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
      <div class="p-6">
        <div class="flex justify-between items-start">
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
            <i class="fa fa-exclamation-triangle text-2xl text-danger"></i>
          </div>
          <button id="closeAlarm" class="text-gray-400 hover:text-gray-600">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <h3 class="text-xl font-bold text-dark mt-4 mb-2">âš ï¸ é¢„è­¦æé†’</h3>
        <p class="text-gray-600 mb-6" id="alarmMessage">è´§ç‰©å åœ°æ¯”ä¾‹å·²è¶…è¿‡å®‰å…¨é˜ˆå€¼ï¼Œè¯·åŠæ—¶å¤„ç†ï¼</p>
        <div class="flex justify-end">
          <button id="confirmAlarm" class="btn-primary">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- é”™è¯¯å¼¹çª— -->
  <div id="errorModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
      <div class="p-6">
        <div class="flex justify-between items-start">
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
            <i class="fa fa-exclamation-circle text-2xl text-danger"></i>
          </div>
          <button id="closeError" class="text-gray-400 hover:text-gray-600">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <h3 class="text-xl font-bold text-dark mt-4 mb-2">âŒ åŠ è½½é”™è¯¯</h3>
        <p class="text-gray-600 mb-6" id="errorMessage">åŠ è½½åˆ†æç»“æœæ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚</p>
        <div class="flex justify-end">
          <button id="confirmError" class="btn-primary">
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script>
    // åˆå§‹åŒ–Chart.jså›¾è¡¨
    let trendChart = null;
    let analysisData = null; // å­˜å‚¨å½“å‰åˆ†æç»“æœæ•°æ®
    let allResults = [];     // å­˜å‚¨æ‰€æœ‰åˆ†æç»“æœ
    let currentFile = null;  // å½“å‰é€‰ä¸­çš„æ–‡ä»¶
    let fileMonitorInterval = null; // æ–‡ä»¶ç›‘æ§é—´éš”
    let autoRefreshInterval = null; // è‡ªåŠ¨åˆ·æ–°é—´éš”
    let lastCheckedTimestamp = null; // ä¸Šæ¬¡æ£€æŸ¥çš„æ—¶é—´æˆ³
    let isAutoRefreshEnabled = true; // è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
    const API_BASE_URL = 'http://10.60.208.29:8080'; // ä¸åç«¯é…ç½®ä¸€è‡´

    // DOMå…ƒç´ 
    const resultBlock = document.getElementById("resultBlock");
    const cargoRatio = document.getElementById("cargoRatio");
    const ratioBar = document.getElementById("ratioBar");
    const efficiencyInfo = document.getElementById("efficiencyInfo");
    const efficiencyText = document.getElementById("efficiencyText");
    const recommendationBox = document.getElementById("recommendationBox");
    const recommendations = document.getElementById("recommendations");
    const alarmModal = document.getElementById("alarmModal");
    const closeAlarm = document.getElementById("closeAlarm");
    const confirmAlarm = document.getElementById("confirmAlarm");
    const alarmMessage = document.getElementById("alarmMessage");
    const systemStatus = document.getElementById("systemStatus");
    const connectionStatus = document.getElementById("connectionStatus");
    const lastUpdateTime = document.getElementById("lastUpdateTime");
    const processedCount = document.getElementById("processedCount");
    const currentFileElement = document.getElementById("currentFile");
    const currentFileName = document.getElementById("currentFileName");
    const timestampInfo = document.getElementById("timestampInfo");
    const timestampText = document.getElementById("timestampText");
    const fileList = document.getElementById("fileList");
    const fileStatusBar = document.getElementById("fileStatusBar");
    const originalImage = document.getElementById("original-image");
    const resultImage = document.getElementById("result-image");
    const noImagePlaceholder = document.getElementById("noImagePlaceholder");
    const noResultPlaceholder = document.getElementById("noResultPlaceholder");
    const loadingModal = document.getElementById("loadingModal");
    const loadingMessage = document.getElementById("loadingMessage");
    const refreshAnalysis = document.getElementById("refreshAnalysis");
    const toggleAutoRefresh = document.getElementById("toggleAutoRefresh");
    const errorModal = document.getElementById("errorModal");
    const closeError = document.getElementById("closeError");
    const confirmError = document.getElementById("confirmError");
    const errorMessage = document.getElementById("errorMessage");

    // æ˜¾ç¤ºåŠ è½½å¼¹çª—
    function showLoading(message = "ç³»ç»Ÿæ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...") {
      loadingMessage.textContent = message;
      loadingModal.classList.remove('opacity-0', 'pointer-events-none');
      loadingModal.querySelector('div').classList.remove('scale-95');
      loadingModal.querySelector('div').classList.add('scale-100');
    }

    // éšè—åŠ è½½å¼¹çª—
    function hideLoading() {
      loadingModal.classList.add('opacity-0', 'pointer-events-none');
      loadingModal.querySelector('div').classList.remove('scale-100');
      loadingModal.querySelector('div').classList.add('scale-95');
    }

    // æ˜¾ç¤ºé¢„è­¦å¼¹çª—
    function showAlarm(message) {
      alarmMessage.textContent = message;
      alarmModal.classList.remove('opacity-0', 'pointer-events-none');
      alarmModal.querySelector('div').classList.remove('scale-95');
      alarmModal.querySelector('div').classList.add('scale-100');
    }

    // å…³é—­é¢„è­¦å¼¹çª—
    function closeAlarmModal() {
      alarmModal.classList.add('opacity-0', 'pointer-events-none');
      alarmModal.querySelector('div').classList.remove('scale-100');
      alarmModal.querySelector('div').classList.add('scale-95');
    }

    // æ˜¾ç¤ºé”™è¯¯å¼¹çª—
    function showError(message, detail = '') {
      errorMessage.textContent = message;
      if (detail) {
        errorMessage.innerHTML += `<br><small class="text-sm text-gray-500">${detail}</small>`;
      }
      errorModal.classList.remove('opacity-0', 'pointer-events-none');
      errorModal.querySelector('div').classList.remove('scale-95');
      errorModal.querySelector('div').classList.add('scale-100');
    }

    // å…³é—­é”™è¯¯å¼¹çª—
    function closeErrorModal() {
      errorModal.classList.add('opacity-0', 'pointer-events-none');
      errorModal.querySelector('div').classList.remove('scale-100');
      errorModal.querySelector('div').classList.add('scale-95');
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'success') {
      const notification = document.createElement("div");
      notification.className = `notification ${type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}`;
      notification.textContent = message;
      notification.style.bottom = "20px";
      notification.style.right = "20px";
      notification.style.opacity = "0";
      notification.style.transform = "translateY(20px)";
      notification.style.transition = "opacity 0.3s, transform 0.3s";

      document.body.appendChild(notification);

      // æ˜¾ç¤ºé€šçŸ¥
      setTimeout(() => {
        notification.style.opacity = "1";
        notification.style.transform = "translateY(0)";
      }, 100);

      // 3ç§’åéšè—é€šçŸ¥
      setTimeout(() => {
        notification.style.opacity = "0";
        notification.style.transform = "translateY(20px)";
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // åŠ è½½å›¾åƒå¹¶æ˜¾ç¤ºå ä½ç¬¦
    function loadImage(imgElement, url, placeholder) {
        // æ˜¾ç¤ºå ä½ç¬¦
        placeholder.style.display = "block";

        // é‡ç½®å›¾åƒ
        imgElement.src = "";

        // åˆ›å»ºæ–°çš„Imageå¯¹è±¡æ¥é¢„åŠ è½½
        const tempImg = new Image();
        tempImg.onload = function() {
            // å›¾ç‰‡åŠ è½½æˆåŠŸåè®¾ç½®src
            imgElement.src = url;
            imgElement.onload = function() {
                // å›¾ç‰‡å®Œå…¨åŠ è½½åéšè—å ä½ç¬¦
                placeholder.style.display = "none";
            };
        };

        tempImg.onerror = function() {
            console.error("å›¾ç‰‡åŠ è½½å¤±è´¥:", url);
            // åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºå ä½ç¬¦å¹¶æç¤ºé”™è¯¯
            placeholder.innerHTML = `
                <i class="fa fa-exclamation-circle text-4xl mb-2 text-red-500"></i>
                <p>å›¾ç‰‡åŠ è½½å¤±è´¥</p>
            `;
            placeholder.style.display = "block";
        };

        // è®¾ç½®å›¾ç‰‡æºå¼€å§‹åŠ è½½
        tempImg.src = url;
    }

    // æ›´æ–°UIæ•°æ®
    function updateUIWithData(data) {
      if (!data) {
        showError("æœªè·å–åˆ°åˆ†ææ•°æ®");
        return;
      }

      // æ˜¾ç¤ºç»“æœåŒºåŸŸ
      resultBlock.style.opacity = "1";
      resultBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
      if (data.error) {
        showError("åˆ†æå¤±è´¥", data.error);
        return;
      }

      // æ›´æ–°å½“å‰æ–‡ä»¶å
      currentFileName.textContent = `æ–‡ä»¶: ${data.file_name}`;

      // æ›´æ–°è´§ç‰©æ¯”ä¾‹
      cargoRatio.textContent = data.cargo_ratio_percent + "%";
      ratioBar.style.width = data.cargo_ratio_percent + "%";

      // æ›´æ–°æ—¶é—´æˆ³
      timestampInfo.style.display = "block";
      timestampText.textContent = data.timestamp;

      // ä½¿ç”¨æ”¹è¿›çš„å›¾ç‰‡åŠ è½½å‡½æ•°
      loadImage(originalImage, `${API_BASE_URL}/original-image/${data.file_name}`, noImagePlaceholder);
      loadImage(resultImage, `${API_BASE_URL}/result-image/${data.file_name}`, noResultPlaceholder);

      // æ˜¾ç¤ºæ•ˆç‡è¯„ä¼°
      efficiencyInfo.style.display = "block";
      let efficiencyClass = "text-success";
      let efficiencyMsg = "ç©ºé—´åˆ©ç”¨ç‡è‰¯å¥½";

      // æ ¹æ®ä¸åŒçš„å æ¯”æ˜¾ç¤ºä¸åŒçš„è¯„ä¼°å†…å®¹
      const ratio = data.cargo_ratio_percent;
      if (ratio > 80) {
        efficiencyClass = "text-danger";
        efficiencyMsg = "ç©ºé—´åˆ©ç”¨ç‡æé«˜ï¼Œä»“åº“æ¥è¿‘é¥±å’ŒçŠ¶æ€ï¼Œå»ºè®®ç«‹å³ä¼˜åŒ–å¸ƒå±€";
      } else if (ratio > 70) {
        efficiencyClass = "text-warning";
        efficiencyMsg = "ç©ºé—´åˆ©ç”¨ç‡è¾ƒé«˜ï¼Œä»“åº“æ¥è¿‘æ»¡è´Ÿè·è¿è¡Œï¼Œå»ºè®®ä¼˜åŒ–å¸ƒå±€";
      } else if (ratio > 60) {
        efficiencyClass = "text-warning";
        efficiencyMsg = "ç©ºé—´åˆ©ç”¨ç‡ä¸­ç­‰ï¼Œå¯ä»¥ä¼˜åŒ–å­˜å‚¨å¸ƒå±€ä»¥æé«˜æ•ˆç‡";
      } else if (ratio > 40) {
        efficiencyClass = "text-info";
        efficiencyMsg = "ç©ºé—´åˆ©ç”¨ç‡è‰¯å¥½ï¼Œæœ‰ä¸€å®šçš„æå‡ç©ºé—´";
      } else {
        efficiencyClass = "text-success";
        efficiencyMsg = "ç©ºé—´åˆ©ç”¨ç‡ä¼˜ç§€ï¼Œå¯èƒ½å­˜åœ¨ç©ºé—´èµ„æºæµªè´¹";
      }

      efficiencyText.innerHTML = `<span class="${efficiencyClass}">${efficiencyMsg}</span>`;

      // æ˜¾ç¤ºä¼˜åŒ–å»ºè®®
      recommendationBox.style.display = "block";
      recommendations.innerHTML = "";

      const recs = [
        "å®šæœŸæ¸…ç†ä»“åº“ï¼Œç§»é™¤ä¸éœ€è¦çš„ç‰©å“",
        "ä¼˜åŒ–è´§æ¶å¸ƒå±€ï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡",
        "å®æ–½å…ˆè¿›å…ˆå‡º(FIFO)ç­–ç•¥ï¼Œå‡å°‘è´§ç‰©ç§¯å‹",
        "è€ƒè™‘ä½¿ç”¨å‚ç›´å­˜å‚¨ç©ºé—´",
        "å»ºç«‹åº“å­˜ç®¡ç†ç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§åº“å­˜æ°´å¹³",
        "é‡æ–°è§„åˆ’è´§ç‰©å­˜æ”¾åŒºåŸŸï¼Œæé«˜ç©ºé—´åˆ†é…æ•ˆç‡",
        "è€ƒè™‘ä½¿ç”¨è‡ªåŠ¨åŒ–å­˜å‚¨è®¾å¤‡ï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡",
        "å¯¹ä»“åº“å‘˜å·¥è¿›è¡ŒåŸ¹è®­ï¼Œæé«˜æ“ä½œæ•ˆç‡"
      ];

      // æ ¹æ®ä¸åŒçš„å æ¯”æ˜¾ç¤ºä¸åŒçš„å»ºè®®
      let selectedRecs = [];
      if (ratio > 75) {
        selectedRecs = [recs[0], recs[1], recs[5], recs[6]];
      } else if (ratio > 60) {
        selectedRecs = [recs[1], recs[2], recs[4], recs[7]];
      } else {
        selectedRecs = [recs[3], recs[4], recs[5], recs[7]];
      }

      // æ·»åŠ éšæœºå»ºè®®
      const shuffled = [...recs].sort(() => 0.5 - Math.random());
      shuffled.slice(0, 1).forEach(rec => {
        if (!selectedRecs.includes(rec)) {
          selectedRecs.push(rec);
        }
      });

      selectedRecs.forEach(rec => {
        const li = document.createElement("li");
        li.textContent = rec;
        recommendations.appendChild(li);
      });

      // åˆ›å»ºè¶‹åŠ¿å›¾è¡¨
      createTrendChart(allResults);

      // æ›´æ–°çŠ¶æ€
      const now = new Date();
      const timeStr = now.toLocaleString();
      lastUpdateTime.textContent = `ä¸Šæ¬¡æ›´æ–°: ${timeStr}`;

      // æ›´æ–°ç³»ç»ŸçŠ¶æ€
      if (ratio > 70) {
        systemStatus.className = "status-badge status-badge-red";
        systemStatus.innerHTML = '<i class="fa fa-circle mr-1"></i>é«˜è´Ÿè·';
      } else if (ratio > 50) {
        systemStatus.className = "status-badge status-badge-yellow";
        systemStatus.innerHTML = '<i class="fa fa-circle mr-1"></i>æ­£å¸¸';
      } else {
        systemStatus.className = "status-badge status-badge-green";
        systemStatus.innerHTML = '<i class="fa fa-circle mr-1"></i>ä½è´Ÿè·';
      }

      // è§¦å‘å¼¹çª—é¢„è­¦
      if (data.alarm) {
        showAlarm(data.alarm_message || "è´§ç‰©å åœ°æ¯”ä¾‹å·²è¶…è¿‡å®‰å…¨é˜ˆå€¼ï¼Œè¯·åŠæ—¶å¤„ç†ï¼");
      }
    }

    // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
    function updateFileList(results) {
      fileList.innerHTML = "";

      if (!results || results.length === 0) {
        fileList.innerHTML = `
          <div class="p-6 text-center ${results.length === 0 ? 'text-gray-400' : 'text-red-500'}">
            <i class="fa ${results.length === 0 ? 'fa-folder-open-o' : 'fa-exclamation-circle'} text-4xl mb-2"></i>
            <p>${results.length === 0 ? 'æš‚æ— åˆ†ææ–‡ä»¶' : 'è·å–åˆ†æç»“æœå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—'}</p>
          </div>
        `;
        return;
      }

      // æ›´æ–°å¤„ç†æ–‡ä»¶è®¡æ•°
      processedCount.textContent = `å·²å¤„ç†: ${results.length} ä¸ªæ–‡ä»¶`;

      // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„æ–‡ä»¶åœ¨å‰é¢
      results.sort((a, b) => {
        return new Date(b.timestamp) - new Date(a.timestamp);
      });

      // è®¡ç®—è¿›åº¦æ¡å®½åº¦
      fileStatusBar.style.width = "100%";

      // æ·»åŠ æ–‡ä»¶é¡¹
      results.forEach(result => {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";
        fileItem.dataset.filename = result.file_name;

        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰é€‰ä¸­çš„æ–‡ä»¶
        if (currentFile === result.file_name) {
          fileItem.classList.add("active");
        }

        // æ ¹æ®æ¯”ä¾‹å€¼ç¡®å®šé¢œè‰²ç±»
        const ratio = result.cargo_ratio_percent;
        let ratioClass = "ratio-success";
        if (ratio >= 70) {
          ratioClass = "ratio-danger";
        } else if (ratio >= 50) {
          ratioClass = "ratio-warning";
        }

        // è®¾ç½®æ–‡ä»¶é¡¹å†…å®¹
        fileItem.innerHTML = `
          <div class="flex items-center">
            <i class="fa fa-file-image-o text-primary mr-3"></i>
            <div>
              <p class="font-medium text-dark">${result.file_name}</p>
              <p class="text-xs text-gray-500">${result.timestamp}</p>
            </div>
          </div>
          <div class="${ratioClass}">${result.cargo_ratio_percent}%</div>
        `;

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        fileItem.addEventListener("click", function() {
          console.log("é€‰æ‹©æ–‡ä»¶:", result.file_name);
          selectFile(result.file_name);
        });

        // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
        fileList.appendChild(fileItem);
      });

      console.log(`æˆåŠŸæ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼Œå…± ${results.length} ä¸ªæ–‡ä»¶`);
    }

    // é€‰æ‹©æ–‡ä»¶
    function selectFile(filename) {
      // æ›´æ–°å½“å‰æ–‡ä»¶
      currentFile = filename;

      // æ›´æ–°æ–‡ä»¶åˆ—è¡¨ä¸­çš„é€‰ä¸­çŠ¶æ€
      const fileItems = document.querySelectorAll(".file-item");
      fileItems.forEach(item => {
        if (item.dataset.filename === filename) {
          item.classList.add("active");
        } else {
          item.classList.remove("active");
        }
      });

      // ä»ç»“æœåˆ—è¡¨ä¸­æ‰¾åˆ°é€‰ä¸­çš„æ–‡ä»¶æ•°æ®
      const result = allResults.find(item => item.file_name === filename);

      if (result) {
        // æ›´æ–°UI
        updateUIWithData(result);

        // æ›´æ–°å½“å‰æ–‡ä»¶æ˜¾ç¤º
        currentFileElement.textContent = `å½“å‰: ${filename}`;
      } else {
        showError(`æœªæ‰¾åˆ°æ–‡ä»¶ ${filename} çš„åˆ†æç»“æœ`);
      }
    }

    // åˆ›å»ºè¶‹åŠ¿å›¾è¡¨
    function createTrendChart(results) {
      const ctx = document.getElementById("trendChart").getContext("2d");

      // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œé”€æ¯å®ƒ
      if (trendChart) {
        trendChart.destroy();
      }

      if (!results || results.length === 0) {
        // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºç©ºå›¾è¡¨
        document.getElementById("trendChart").parentElement.innerHTML = `
          <div class="h-full flex items-center justify-center text-gray-400">
            <i class="fa fa-chart-line text-4xl mr-3"></i>
            <p>æš‚æ— è¶‹åŠ¿æ•°æ®</p>
          </div>
        `;
        return;
      }

      // æŒ‰æ—¶é—´é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
      results.sort((a, b) => {
        return new Date(b.timestamp) - new Date(a.timestamp);
      });

      // åªå–æœ€è¿‘30æ¡è®°å½•
      const recentResults = results.slice(0, 30);

      // æŒ‰æ—¶é—´å‡åºæ’åºï¼ˆæ—§çš„åœ¨å‰é¢ï¼Œæ–°çš„åœ¨åé¢ï¼‰
      recentResults.sort((a, b) => {
        return new Date(a.timestamp) - new Date(b.timestamp);
      });

      // å‡†å¤‡å›¾è¡¨æ•°æ®
      const labels = recentResults.map(item => {
        const date = new Date(item.timestamp);
        return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      });

      const data = recentResults.map(item => item.cargo_ratio_percent);

      // åˆ›å»ºå›¾è¡¨
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'è´§ç‰©å åœ°æ¯”ä¾‹ (%)',
            data: data,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointBackgroundColor: '#3B82F6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return `è´§ç‰©å åœ°æ¯”ä¾‹: ${context.raw}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                drawBorder: false,
              }
            },
            x: {
              grid: {
                display: false,
                drawBorder: false,
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          }
        }
      });
    }

    // è·å–æ–‡ä»¶åˆ—è¡¨
    async function fetchFileList() {
      showLoading("æ­£åœ¨è·å–æ–‡ä»¶åˆ—è¡¨...");

      try {
        const response = await fetch(`${API_BASE_URL}/results`);

        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
        }

        const data = await response.json();

        // ä¿å­˜æ‰€æœ‰ç»“æœ
        allResults = data;

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
        updateFileList(allResults);

        // å¦‚æœæœ‰æ–‡ä»¶ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
        if (allResults.length > 0) {
          selectFile(allResults[0].file_name);
        }

        console.log("æˆåŠŸè·å–æ–‡ä»¶åˆ—è¡¨");
      } catch (error) {
        console.error("è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:", error);
        showError("è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥", "è¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥æˆ–åç«¯æœåŠ¡çŠ¶æ€");
      } finally {
        hideLoading();
      }
    }

    // è·å–ç›‘æ§çŠ¶æ€
    async function fetchMonitorStatus() {
      try {
        const response = await fetch(`${API_BASE_URL}/status`);

        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
        }

        const data = await response.json();

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        if (data.status === "ç›‘æ§ä¸­") {
          systemStatus.className = "status-badge status-badge-green";
          systemStatus.innerHTML = '<i class="fa fa-circle mr-1"></i>ç›‘æ§ä¸­';
          connectionStatus.className = "status-badge status-badge-green";
          connectionStatus.innerHTML = '<i class="fa fa-check mr-1"></i>å·²è¿æ¥';
        } else if (data.status.includes("é”™è¯¯")) {
          systemStatus.className = "status-badge status-badge-red";
          systemStatus.innerHTML = `<i class="fa fa-circle mr-1"></i>${data.status}`;
          connectionStatus.className = "status-badge status-badge-red";
          connectionStatus.innerHTML = '<i class="fa fa-exclamation-circle mr-1"></i>é”™è¯¯';
        } else {
          systemStatus.className = "status-badge status-badge-yellow";
          systemStatus.innerHTML = `<i class="fa fa-circle mr-1"></i>${data.status}`;
          connectionStatus.className = "status-badge status-badge-yellow";
          connectionStatus.innerHTML = '<i class="fa fa-clock-o mr-1"></i>ç­‰å¾…ä¸­';
        }

        // æ›´æ–°æ–‡ä»¶å¤„ç†è¿›åº¦
        processedCount.textContent = `å·²å¤„ç†: ${data.processed_count} ä¸ªæ–‡ä»¶`;
        fileStatusBar.style.width = "100%";

        // æ›´æ–°å½“å‰å¤„ç†æ–‡ä»¶
        if (data.current_file) {
          currentFileElement.textContent = `å½“å‰: ${getFileNameFromPath(data.current_file)}`;
        } else {
          currentFileElement.textContent = "å½“å‰: æ— ";
        }

        console.log("æˆåŠŸè·å–ç›‘æ§çŠ¶æ€");
      } catch (error) {
        console.error("è·å–ç›‘æ§çŠ¶æ€å¤±è´¥:", error);
        systemStatus.className = "status-badge status-badge-red";
        systemStatus.innerHTML = '<i class="fa fa-circle mr-1"></i>å·²æ–­å¼€';
        connectionStatus.className = "status-badge status-badge-red";
        connectionStatus.innerHTML = '<i class="fa fa-exclamation-triangle mr-1"></i>è¿æ¥å¤±è´¥';
      }
    }

    // ä»æ–‡ä»¶è·¯å¾„ä¸­æå–æ–‡ä»¶å
    function getFileNameFromPath(path) {
      return path.split('/').pop();
    }

    // æ‰‹åŠ¨åˆ·æ–°åˆ†æ
    async function refreshAnalysisManually() {
      if (systemStatus.className.includes("status-badge-red")) {
        showError("ç³»ç»ŸçŠ¶æ€å¼‚å¸¸", "åç«¯æœåŠ¡å¯èƒ½å·²åœæ­¢ï¼Œè¯·å…ˆæ£€æŸ¥åç«¯è¿è¡ŒçŠ¶æ€");
        return;
      }

      showLoading("æ­£åœ¨åˆ·æ–°åˆ†æç»“æœ...");

      try {
        // ç®€å•çš„GETè¯·æ±‚åˆ·æ–°
        const response = await fetch(`${API_BASE_URL}/detect`);

        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
        }

        const data = await response.json();

        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        await fetchFileList();

        showNotification("åˆ†æç»“æœå·²åˆ·æ–°", 'success');
      } catch (error) {
        console.error("åˆ·æ–°åˆ†æå¤±è´¥:", error);
        showError("åˆ·æ–°åˆ†æå¤±è´¥", "è¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥æˆ–åç«¯æœåŠ¡çŠ¶æ€");
      } finally {
        hideLoading();
      }
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç»“æœ
    async function checkForNewResults() {
      if (isAutoRefreshEnabled) {
        try {
          // æ„å»ºè¯·æ±‚URLï¼Œå¸¦ä¸Šä¸Šæ¬¡æ£€æŸ¥çš„æ—¶é—´æˆ³
          let url = `${API_BASE_URL}/has_new_results`;
          if (lastCheckedTimestamp) {
            url += `?timestamp=${encodeURIComponent(lastCheckedTimestamp)}`;
          }

          const response = await fetch(url);
          const data = await response.json();

          if (data.has_new) {
            // æœ‰æ–°ç»“æœï¼Œåˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            console.log("æ£€æµ‹åˆ°æ–°çš„åˆ†æç»“æœï¼Œæ­£åœ¨åˆ·æ–°...");
            await fetchFileList();
            lastCheckedTimestamp = data.timestamp;

            showNotification("å·²è‡ªåŠ¨æ›´æ–°åˆ†æç»“æœ", 'success');
          } else {
            // æ²¡æœ‰æ–°ç»“æœï¼Œæ›´æ–°æ—¶é—´æˆ³
            if (data.timestamp) {
              lastCheckedTimestamp = data.timestamp;
            }
          }
        } catch (error) {
          console.error("æ£€æŸ¥æ–°ç»“æœæ—¶å‡ºé”™:", error);
          showNotification("è‡ªåŠ¨åˆ·æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", 'error');
        }
      }
    }

    // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
    function toggleAutoRefreshStatus() {
      isAutoRefreshEnabled = !isAutoRefreshEnabled;

      if (isAutoRefreshEnabled) {
        autoRefreshInterval = setInterval(checkForNewResults, 6000); // æ¯6ç§’æ£€æŸ¥ä¸€æ¬¡
        toggleAutoRefresh.innerHTML = '<i class="fa fa-sync-alt mr-2"></i>è‡ªåŠ¨åˆ·æ–°: å¯ç”¨';
        toggleAutoRefresh.className = "btn-primary flex items-center";
        showNotification("è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨", 'success');
      } else {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        toggleAutoRefresh.innerHTML = '<i class="fa fa-sync-alt mr-2"></i>è‡ªåŠ¨åˆ·æ–°: ç¦ç”¨';
        toggleAutoRefresh.className = "btn-refresh flex items-center";
        showNotification("è‡ªåŠ¨åˆ·æ–°å·²ç¦ç”¨", 'success');
      }
    }

    // åˆå§‹åŒ–è‡ªåŠ¨åˆ·æ–°
    function initAutoRefresh() {
      // è®¾ç½®å®šæ—¶æ£€æŸ¥
      autoRefreshInterval = setInterval(checkForNewResults, 6000);
      console.log("å·²å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼Œæ¯6ç§’æ£€æŸ¥ä¸€æ¬¡æ–°ç»“æœ");
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");

      // åˆå§‹åŒ–è‡ªåŠ¨åˆ·æ–°
      initAutoRefresh();

      // è·å–ç›‘æ§çŠ¶æ€
      await fetchMonitorStatus();

      // è·å–æ–‡ä»¶åˆ—è¡¨
      await fetchFileList();

      // è®¾ç½®å®šæœŸè·å–ç›‘æ§çŠ¶æ€
      fileMonitorInterval = setInterval(fetchMonitorStatus, 5000);

      // ç»‘å®šæ‰‹åŠ¨åˆ·æ–°æŒ‰é’®äº‹ä»¶
      refreshAnalysis.addEventListener('click', refreshAnalysisManually);

      // ç»‘å®šè‡ªåŠ¨åˆ·æ–°åˆ‡æ¢æŒ‰é’®äº‹ä»¶
      toggleAutoRefresh.addEventListener('click', toggleAutoRefreshStatus);

      console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆ");

       // ç»‘å®šé¢„è­¦å¼¹çª—äº‹ä»¶
      const closeAlarmBtn = document.getElementById('closeAlarm');
      const confirmAlarmBtn = document.getElementById('confirmAlarm');

      if (closeAlarmBtn) {
        closeAlarmBtn.addEventListener('click', closeAlarmModal);
      }

      if (confirmAlarmBtn) {
        confirmAlarmBtn.addEventListener('click', closeAlarmModal);
      }

      // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
      alarmModal.addEventListener('click', function(e) {
        if (e.target === alarmModal) {
          closeAlarmModal();
        }
      });
    });

    // ç»‘å®šé”™è¯¯å¼¹çª—å…³é—­äº‹ä»¶
    const closeErrorBtn = document.getElementById('closeError');
    const confirmErrorBtn = document.getElementById('confirmError');

    if (closeErrorBtn) {
      closeErrorBtn.addEventListener('click', closeErrorModal);
    }

    if (confirmErrorBtn) {
      confirmErrorBtn.addEventListener('click', closeErrorModal);
    }

    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
    errorModal.addEventListener('click', function(e) {
      if (e.target === errorModal) {
        closeErrorModal();
      }
    });


    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function() {
      if (fileMonitorInterval) {
        clearInterval(fileMonitorInterval);
      }

      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });

  </script>
</body>
</html>